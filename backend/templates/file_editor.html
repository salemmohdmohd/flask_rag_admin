<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Markdown File Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <style>
      body { padding: 24px; }
      textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .file-list { max-height: 50vh; overflow: auto; }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3">Markdown File Editor</h1>
        <div class="text-muted">Admin: <strong>{{ g.admin_user.username if g.admin_user else 'unknown' }}</strong></div>
      </div>

      <div class="row g-3">
        <div class="col-12 col-lg-3">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>Resources</span>
              <button id="btn-refresh" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
            <div class="card-body p-2 file-list">
              <ul id="file-list" class="list-unstyled mb-0"></ul>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-9">
          <div class="card h-100">
            <div class="card-header">
              <div class="row g-2 align-items-center">
                <div class="col-auto">Editing:</div>
                <div class="col"><input id="path" class="form-control form-control-sm" placeholder="relative/path.md" /></div>
                <div class="col-auto">
                  <button id="btn-load" class="btn btn-sm btn-outline-primary">Load</button>
                  <button id="btn-save" class="btn btn-sm btn-primary">Save</button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <textarea id="content" class="form-control" rows="22" placeholder="# Markdown content..."></textarea>
              <div id="status" class="form-text mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function setStatus(msg, type = 'muted') {
        const el = document.getElementById('status');
        el.className = `form-text mt-2 text-${type}`;
        el.textContent = msg;
      }

      async function api(path, options = {}) {
        const res = await fetch(`/api${path}`, {
          credentials: 'same-origin',
          headers: Object.assign({'Content-Type': options.body instanceof FormData ? undefined : 'application/json'}, options.headers || {}),
          method: options.method || 'GET',
          body: options.body instanceof FormData ? options.body : (options.body ? JSON.stringify(options.body) : null),
        });
        const text = await res.text();
        let data; try { data = JSON.parse(text) } catch { data = { raw: text } }
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
      }

      async function refreshList() {
        const ul = document.getElementById('file-list');
        ul.innerHTML = '<li class="text-muted px-2">Loading...</li>';
        try {
          const data = await api('/admin/resources');
          ul.innerHTML = '';
          if (!data.items || !data.items.length) {
            ul.innerHTML = '<li class="text-muted px-2">No files.</li>';
            return;
          }
          data.items.forEach(it => {
            const li = document.createElement('li');
            li.className = 'px-2 py-1 d-flex justify-content-between align-items-center';
            const a = document.createElement('a');
            a.href = '#'; a.textContent = it.path; a.onclick = (e) => { e.preventDefault(); selectPath(it.path); };
            const small = document.createElement('small'); small.className = 'text-muted'; small.textContent = `${Math.round(it.size)} B`;
            li.appendChild(a); li.appendChild(small); ul.appendChild(li);
          });
        } catch (e) {
          ul.innerHTML = `<li class='text-danger px-2'>Error: ${e.message}</li>`;
        }
      }

      function selectPath(p) {
        document.getElementById('path').value = p;
        loadFile();
      }

      async function loadFile() {
        const p = (document.getElementById('path').value || '').trim();
        if (!p) { setStatus('Enter a path to load', 'warning'); return; }
        setStatus('Loading...');
        try {
          const data = await api(`/admin/resource?path=${encodeURIComponent(p)}`);
          document.getElementById('content').value = data.content || '';
          setStatus('Loaded.');
        } catch (e) { setStatus('Load failed: ' + e.message, 'danger'); }
      }

      async function saveFile() {
        const p = (document.getElementById('path').value || '').trim();
        const content = document.getElementById('content').value;
        if (!p) { setStatus('Enter a path to save', 'warning'); return; }
        if (!p.toLowerCase().endsWith('.md')) { setStatus('Only .md files allowed', 'warning'); return; }
        setStatus('Saving...');
        try {
          await api('/admin/resource', { method: 'PUT', body: { path: p, content } });
          setStatus('Saved.');
          await refreshList();
        } catch (e) { setStatus('Save failed: ' + e.message, 'danger'); }
      }

      document.getElementById('btn-refresh').addEventListener('click', refreshList);
      document.getElementById('btn-load').addEventListener('click', loadFile);
      document.getElementById('btn-save').addEventListener('click', saveFile);
      refreshList();
    </script>
  </body>
  </html>
