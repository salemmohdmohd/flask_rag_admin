<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>RAG Admin Tools</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <style> body{padding:24px} pre{white-space:pre-wrap} .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace} </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mb-3">RAG Admin Tools</h1>
      <p class="text-muted">Manage resources and indexing. You are logged in as <strong>{{ g.admin_user.username if g.admin_user else 'unknown' }}</strong>.</p>

      <div class="row g-4">
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header">Reindex</div>
            <div class="card-body">
              <button id="btn-reindex" class="btn btn-primary btn-sm">Trigger Reindex</button>
              <div id="reindex-result" class="mt-2 small mono"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header">Upload Resource (.md)</div>
            <div class="card-body">
              <div class="mb-2">
                <input type="file" id="file-input" class="form-control form-control-sm" accept=".md" />
              </div>
              <div class="input-group input-group-sm mb-2">
                <span class="input-group-text">Subdir</span>
                <input type="text" id="subdir" class="form-control" placeholder="optional/subdir" />
              </div>
              <button id="btn-upload" class="btn btn-success btn-sm">Upload</button>
              <div id="upload-result" class="mt-2 small mono"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-header">Audit Log</div>
            <div class="card-body">
              <button id="btn-load-audit" class="btn btn-outline-secondary btn-sm">Load Audit</button>
              <ul id="audit-list" class="mt-2 small"></ul>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-header">Resources</div>
        <div class="card-body">
          <button id="btn-load" class="btn btn-outline-secondary btn-sm">Refresh List</button>
          <ul id="res-list" class="mt-2 small"></ul>
        </div>
      </div>
    </div>

    <script>
      async function api(path, options = {}) {
        const res = await fetch(`/api${path}`, {
          credentials: 'same-origin',
          headers: options.headers || {},
          method: options.method || 'GET',
          body: options.body || null,
        });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text } }
        if (!res.ok) throw new Error((data && data.error) || res.statusText);
        return data;
      }

      async function loadResources() {
        const list = document.getElementById('res-list');
        list.innerHTML = 'Loading...';
        try {
          const data = await api('/admin/resources');
          list.innerHTML = '';
          if (!data.items || !data.items.length) {
            list.innerHTML = '<li class="text-muted">No resources found.</li>';
            return;
          }
          data.items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.path} (${item.size} bytes)`;
            const btn = document.createElement('button');
            btn.className = 'btn btn-link btn-sm';
            btn.textContent = 'Delete';
            btn.onclick = async () => {
              if (!confirm(`Delete ${item.path}?`)) return;
              try {
                await api('/admin/resources', {
                  method: 'DELETE',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ path: item.path }),
                });
                await loadResources();
              } catch (e) {
                alert('Delete failed: ' + e.message);
              }
            };
            li.appendChild(document.createTextNode(' '));
            li.appendChild(btn);
            list.appendChild(li);
          });
        } catch (e) {
          list.innerHTML = `<li class="text-danger">Error: ${e.message}</li>`;
        }
      }

      async function triggerReindex() {
        const out = document.getElementById('reindex-result');
        out.textContent = 'Reindexing...';
        try {
          const data = await api('/admin/reindex', { method: 'POST' });
          out.textContent = JSON.stringify(data);
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      }

      async function uploadFile() {
        const fileInput = document.getElementById('file-input');
        const subdir = document.getElementById('subdir').value;
        if (!fileInput.files.length) { alert('Pick a .md file'); return; }
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        if (subdir) fd.append('subdir', subdir);
        const out = document.getElementById('upload-result');
        out.textContent = 'Uploading...';
        try {
          const data = await api('/admin/resources', { method: 'POST', body: fd });
          out.textContent = JSON.stringify(data);
          fileInput.value = '';
          await loadResources();
        } catch (e) { out.textContent = 'Error: ' + e.message; }
      }

      async function loadAudit() {
        const list = document.getElementById('audit-list');
        list.innerHTML = 'Loading...';
        try {
          const data = await api('/admin/audit');
          list.innerHTML = '';
          if (!data.items || !data.items.length) {
            list.innerHTML = '<li class="text-muted">No audit entries.</li>';
            return;
          }
          data.items.forEach(a => {
            const li = document.createElement('li');
            li.textContent = `[${a.timestamp}] ${a.action} ${a.file_path} by user ${a.user_id}`;
            list.appendChild(li);
          });
        } catch (e) { list.innerHTML = `<li class="text-danger">Error: ${e.message}</li>`; }
      }

      document.getElementById('btn-reindex').addEventListener('click', triggerReindex);
      document.getElementById('btn-upload').addEventListener('click', uploadFile);
      document.getElementById('btn-load').addEventListener('click', loadResources);
      document.getElementById('btn-load-audit').addEventListener('click', loadAudit);
      // initial load
      loadResources();
    </script>
  </body>
  </html>
